# Query to find top 5 customers from top 10 countries

WITH top_ten_countries (country) AS
(SELECT cntry1.country
FROM Customer AS cust1
INNER JOIN address AS addr1 ON cust1.address_id = addr1.address_id
INNER JOIN city AS ct1 ON addr1.city_id = ct1.city_id
INNER JOIN country AS cntry1 ON ct1.country_id = cntry1.country_id
GROUP BY cntry1.country
ORDER BY COUNT (cust1.customer_id) DESC
LIMIT 10),
top_ten_cities (city) AS
(SELECT ct2.city
FROM customer AS cust2
INNER JOIN address AS addr2 ON cust2.address_id = addr2.address_id
INNER JOIN city AS ct2 ON addr2.city_id = ct2.city_id
INNER JOIN country AS cntry2 ON ct2.country_id = cntry2.country_id
INNER JOIN top_ten_countries ON top_ten_countries. country = cntry2.country
GROUP BY ct2.city
ORDER BY COUNT (cust2.customer_id) DESC
LIMIT 10),
top_five_customer (amount) AS
(SELECT SUM (pmt3.amount) AS total_amount_paid 
FROM payment AS pmt3
INNER JOIN customer AS cust3 ON pmt3.customer_id = cust3.customer_id
INNER JOIN address AS addr3 ON cust3.address_id = addr3.address_id
INNER JOIN city AS ct3 ON addr3.city_id = ct3.city_id
INNER JOIN country AS cntry3 ON ct3.country_id = cntry3.country_id
INNER JOIN top_ten_cities ON top_ten_cities. City = ct3.city
GROUP BY cust3.customer_id
ORDER BY total_amount_paid DESC
LIMIT 5)
SELECT AVG (amount)
FROM top_five_customer;
