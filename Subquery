# Subquery to find Top 5 customers

SELECT cntry1.country,
COUNT (DISTINCT cust1.customer_id) AS all_customer_count,
COUNT (DISTINCT top_five_customers. country) AS top_customer_count
FROM customer AS cust1
INNER JOIN address AS addr1 ON cust1.address_id = addr1.address_id
INNER JOIN city AS ct1 ON addr1.city_id = ct1.city_id
INNER JOIN country AS cntry1 ON ct1.country_id = cntry1.country_id
LEFT JOIN
(SELECT cust2.customer_id, ct2.city, cntry2.country,
SUM (pmt. amount) AS total_amount_paid
FROM payment AS pmt
INNER JOIN customer AS cust2 ON pmt. customer_id = cust2.customer_id
INNER JOIN address AS addr2 ON cust2.address_id = addr2.address_id
INNER JOIN city AS ct2 ON addr2.city_id = ct2.city_id
INNER JOIN country AS cntry2 ON ct2.country_id = cntry2.country_id
WHERE ct2.city IN
(SELECT ct3.city
FROM customer AS cust3
INNER JOIN address AS addr3 ON cust3.address_id = addr3.address_id
INNER JOIN city AS ct3 ON addr3.city_id = ct3.city_id
INNER JOIN country AS cntry3 ON ct3.country_id = cntry3.country_id
WHERE cntry3.country IN
(SELECT cntry4.country
FROM customer AS cust4
INNER JOIN address AS addr4 ON cust4.address_id = addr4.address_id
INNER JOIN city AS ct4 ON addr4.city_id = ct4.city_id
INNER JOIN country AS cntry4 ON ct4.country_id = cntry4.country_id
GROUP BY cntry4.country
ORDER BY COUNT (cust4.customer_id) DESC
LIMIT 10)
GROUP BY ct3.city
ORDER BY COUNT (cust3.customer_id) DESC
LIMIT 10)
GROUP BY cust2.customer_id, ct2.city, cntry2.country
ORDER BY total_amount_paid DESC
LIMIT 5) AS top_five_customers ON top_five_customers. country = cntry1.country
GROUP BY cntry1.country
ORDER BY top_customer_count DESC;
